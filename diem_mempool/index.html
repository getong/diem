<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Mempool is used to hold transactions that have been submitted but not yet agreed upon and executed."><title>diem_mempool - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-c4dbdcde0fbd8430.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../static.files/light-db279b6232be9c13.css"><link rel="stylesheet" disabled href="../static.files/dark-cf923f49f397b216.css"><link rel="stylesheet" disabled href="../static.files/ayu-be46fdc453a55015.css"><script src="../static.files/storage-3891ce972e3a2bf8.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-98a684e84ae5b08b.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../diem_mempool/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../diem_mempool/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Crate diem_mempool</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 0.1.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">diem_mempool</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/diem_mempool/lib.rs.html#4-73">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Mempool is used to hold transactions that have been submitted but not yet agreed upon and
executed.</p>
<p><strong>Flow</strong>: AC sends transactions into mempool which holds them for a period of time before
sending them into consensus.  When a new transaction is added, Mempool shares this transaction
with other nodes in the system.  This is a form of “shared mempool” in that transactions between
mempools are shared with other validators.  This helps maintain a pseudo global ordering since
when a validator receives a transaction from another mempool, it will be ordered when added in
the ordered queue of the recipient validator. To reduce network consumption, in “shared mempool”
each validator is responsible for delivery of its own transactions (we don’t rebroadcast
transactions originated on a different peer). Also we only broadcast transactions that have some
chance to be included in next block: their sequence number equals to the next sequence number of
account or sequential to it. For example, if the current sequence number for an account is 2 and
local mempool contains transactions with sequence numbers 2,3,4,7,8, then only transactions 2, 3
and 4 will be broadcast.</p>
<p>Consensus pulls transactions from mempool rather than mempool pushing into consensus. This is
done so that while consensus is not yet ready for transactions, we keep ordering based on gas
and consensus can let transactions build up.  This allows for batching of transactions into a
single consensus block as well as prioritizing by gas price. Mempool doesn’t  keep track of
transactions that were sent to Consensus. On each get_block request, Consensus additionally
sends a set of transactions that were pulled from Mempool so far but were not committed yet.
This is done so Mempool can be agnostic about different Consensus proposal branches.  Once a
transaction is fully executed and written to storage,  Consensus notifies Mempool about it which
later drops it from its internal state.</p>
<p><strong>Internals</strong>: Internally Mempool is modeled as <code>HashMap&lt;AccountAddress, AccountTransactions&gt;</code>
with various indexes built on top of it. The main index <code>PriorityIndex</code> is an ordered queue of
transactions that are “ready” to be included in next block(i.e. have sequence number sequential
to current for account). This queue is ordered by gas price so that if a client is willing to
pay more (than other clients) per unit of execution, then they can enter consensus earlier. Note
that although global ordering is maintained by gas price, for a single account, transactions are
ordered by sequence number.</p>
<p>All transactions that are not ready to be included in the next block are part of separate
<code>ParkingLotIndex</code>. They will be moved to the ordered queue once some event unblocks them. For
example, Mempool has transaction with sequence number 4, while current sequence number for that
account is 3. Such transaction is considered to be “non-ready”. Then callback from Consensus
notifies that transaction was committed(i.e. transaction 3 was submitted to different node).
Such event “unblocks” local transaction and txn4 will be moved to OrderedQueue.</p>
<p>Mempool only holds a limited number of transactions to prevent OOMing the system. Additionally
there’s a limit of number of transactions per account to prevent different abuses/attacks</p>
<p>Transactions in Mempool have two types of expirations: systemTTL and client-specified
expiration. Once we hit either of those, the transaction is removed from Mempool. SystemTTL is
checked periodically in the background, while the client-specified expiration is checked on
every Consensus commit request. We use a separate system TTL to ensure that a transaction won’t
remain stuck in Mempool forever, even if Consensus doesn’t make progress</p>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="fuzzing/index.html" title="mod diem_mempool::fuzzing">fuzzing</a></div></li><li><div class="item-name"><a class="mod" href="mocks/index.html" title="mod diem_mempool::mocks">mocks</a></div></li><li><div class="item-name"><a class="mod" href="network/index.html" title="mod diem_mempool::network">network</a></div><div class="desc docblock-short">Interface between Mempool and Network layers.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.TransactionSummary.html" title="struct diem_mempool::TransactionSummary">TransactionSummary</a></div></li></ul><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.ConsensusRequest.html" title="enum diem_mempool::ConsensusRequest">ConsensusRequest</a></div><div class="desc docblock-short">Message sent from consensus to mempool.</div></li><li><div class="item-name"><a class="enum" href="enum.ConsensusResponse.html" title="enum diem_mempool::ConsensusResponse">ConsensusResponse</a></div><div class="desc docblock-short">Response sent from mempool to consensus.</div></li></ul><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.bootstrap.html" title="fn diem_mempool::bootstrap">bootstrap</a></div></li><li><div class="item-name"><a class="fn" href="fn.gen_mempool_reconfig_subscription.html" title="fn diem_mempool::gen_mempool_reconfig_subscription">gen_mempool_reconfig_subscription</a></div></li></ul><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><ul class="item-table"><li><div class="item-name"><a class="type" href="type.MempoolClientSender.html" title="type diem_mempool::MempoolClientSender">MempoolClientSender</a></div></li><li><div class="item-name"><a class="type" href="type.SubmissionStatus.html" title="type diem_mempool::SubmissionStatus">SubmissionStatus</a></div></li></ul></section></div></main><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="diem_mempool" data-themes="" data-resource-suffix="" data-rustdoc-version="1.69.0 (84c898d65 2023-04-16)" data-search-js="search-8a59a8356673ec1f.js" data-settings-js="settings-f0c5c39777a9a2f6.js" data-settings-css="settings-0bcba95ff279c1db.css" ></div></body></html>